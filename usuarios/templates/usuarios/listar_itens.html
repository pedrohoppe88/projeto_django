{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Itens da Sess√£o {{ sessao.nome }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{% static 'style/listar_itens.css' %}">
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>Dashboard</h2>
        <a href="{% url 'listar_sessoes' %}" class="btn btn-outline-light">
            ‚Üê Voltar para Sess√µes
        </a>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCadastrarItem">
            ‚ûï Adicionar Item
        </button>
        <a href="{% url 'gerar_relatorio_pdf' sessao.id %}" class="btn btn-pdf" target="_blank">
            üìù Gerar Relat√≥rio PDF
        </a>
    </aside>

    <!-- Main content -->
    <main class="main-content">
        <header class="main-header">
            Itens da Sess√£o <span class="session-name">{{ sessao.nome }}</span>
        </header>

        <!-- Pesquisa principal -->
        <div class="search-container">
            <input type="text" id="pesquisaItem" placeholder="üîç Pesquisar item pelo nome..." aria-label="Pesquisar item" />
        </div>

        <section class="cards-container" id="listaItens">
            {% for item in itens %}
            <article class="card-item" data-nome="{{ item.nome|lower }}">
                <header class="card-header">
                    <span>{{ item.nome }}</span>
                    <form action="{% url 'excluir_item' item.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn-excluir" onclick="return confirm('Tem certeza que deseja excluir este item?');">
                            ‚úñ
                        </button>
                    </form>
                </header>

                <div class="card-body">
                    <div class="card-quantity">{{ item.quantidade }} unidades cadastradas</div>

                    <!-- Pesquisa dentro do card - Quem Pegou -->
                    <div class="card-search-container">
                        <input type="search" id="search-pegou-{{ item.id }}" class="card-search" 
                               placeholder="üîç Pesquisar quem pegou..." oninput="filterRetiradas({{ item.id }}, 'pegou')" />
                    </div>

                    <h6>Retiradas:</h6>
                    <ul class="retirada-list" id="list-pegou-{{ item.id }}">
                        {% for retirada in item.retiradas.all %}
                        <li class="retirada-item" data-usuario="{{ retirada.usuario.nome|lower }}">
                            <div class="retirada-info">
                                <strong>{{ retirada.usuario.nome }}</strong>
                                <span class="badge-quantidade">{{ retirada.quantidade }}</span>
                                <small>em {{ retirada.data_retirada|date:"d/m/Y H:i" }}</small>
                            </div>
                            <form method="post" action="{% url 'remover_retirada' retirada.id %}?next={% url 'listar_itens' sessao.id %}" class="form-remover">
                                {% csrf_token %}
                                <input type="number" name="quantidade" min="1" max="{{ retirada.quantidade }}" value="{{ retirada.quantidade }}" required />
                                <button type="submit" title="Remover retirada">‚úñ</button>
                            </form>
                        </li>
                        {% empty %}
                        <li class="retirada-item text-muted fst-italic" id="retirada-item">Ningu√©m retirou ainda</li>
                        {% endfor %}
                    </ul>


                    <form method="post" action="{% url 'retirar_item' item.id %}" class="form-retirar">
                        {% csrf_token %}
                        <label for="usuario-{{ item.id }}">Quem pegou:</label>
                        <select id="usuario-{{ item.id }}" name="usuario" required>
                            {% for usuario in usuarios %}
                            <option value="{{ usuario.id }}">{{ usuario.nome }} - {{ usuario.get_graduacao_display }}</option>
                            {% endfor %}
                        </select>

                        <label for="quantidade-{{ item.id }}">Quantidade:</label>
                        <input id="quantidade-{{ item.id }}" type="number" name="quantidade" min="1" max="{{ item.quantidade }}" value="1" required />

                        <button type="submit">Registrar Retirada</button>
                    </form>
                </div>
            </article>
            {% empty %}
            <div class="alert alert-info w-100 text-center" role="alert" style="background-color: var(--input-bg); color: var(--text-light); border: none;">
                Nenhum item cadastrado ainda. Clique em "Adicionar Item" para come√ßar.
            </div>
            {% endfor %}
        </section>
    </main>

    <!-- Modal para Cadastrar Item -->
    <div class="modal fade" id="modalCadastrarItem" tabindex="-1" aria-labelledby="modalCadastrarItemLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'adicionar_item' sessao.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Cadastrar Novo Item</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="nomeItem">Nome do Item</label>
                        <input type="text" id="nomeItem" name="nome" required />
                        
                        <label for="quantidadeItem">Quantidade</label>
                        <input type="number" id="quantidadeItem" name="quantidade" min="1" required />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Pesquisa geral dos itens
        const inputPesquisa = document.getElementById("pesquisaItem");
        const listaItens = document.getElementById("listaItens");

        inputPesquisa.addEventListener("input", () => {
            const filtro = inputPesquisa.value.toLowerCase().trim();
            const cards = listaItens.querySelectorAll("article.card-item");

            cards.forEach(card => {
                const nome = card.getAttribute("data-nome");
                if (filtro === "" || nome.includes(filtro)) {
                    card.style.display = "";
                } else {
                    card.style.display = "none";
                }
            });
        });

        // Filtrar retiradas "Quem pegou"
        function filterRetiradas(itemId, tipo) {
            const input = document.getElementById(`search-pegou-${itemId}`);
            const filtro = input.value.toLowerCase().trim();
            const lista = document.getElementById(`list-pegou-${itemId}`);
            const itens = lista.querySelectorAll(".retirada-item");

            itens.forEach(li => {
                const usuario = li.getAttribute("data-usuario");
                if (filtro === "" || usuario.includes(filtro)) {
                    li.style.display = "";
                } else {
                    li.style.display = "none";
                }
            });
        }

        // Filtrar cautelados "Quem est√° cautelado"
        function filterCautelados(itemId) {
            const input = document.getElementById(`search-cautelado-${itemId}`);
            const filtro = input.value.toLowerCase().trim();
            const lista = document.getElementById(`list-cautelado-${itemId}`);
            const itens = lista.querySelectorAll(".cautelado-item");

            itens.forEach(li => {
                const usuario = li.getAttribute("data-usuario");
                if (filtro === "" || usuario.includes(filtro)) {
                    li.style.display = "";
                } else {
                    li.style.display = "none";
                }
            });
        }

        // Animar cards ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card-item');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
        });
    </script>

</body>
</html>
